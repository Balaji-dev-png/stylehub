{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <script>
        // Inject theme early to prevent flash of white content
        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
        }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile | Stylehub</title>
    <link rel="stylesheet" href="{% static 'theme.css' %}?v=3">
    <link rel="stylesheet" href="{% static 'style11.css' %}?v=2">
    <script src="{% static 'main.js' %}?v=3" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>

<body>

    <!-- Standard Navbar -->
    <header>
        <nav class="navbar">
            <div class="logo">Style<span>hub</span></div>
            <ul class="nav-links">
                <li><a href="{% url 'home' %}">Home</a></li>
                <li><a href="{% url 'pro_list' %}">Shop</a></li>
                <li><a href="{% url 'new' %}">New Arrivals</a></li>
                <li><a href="{% url 'contact' %}">Contact</a></li>
                <li><a href="{% url 'profile' %}" class="active">Profile</a></li>
            </ul>
            <div class="nav-icons" style="display: flex; align-items: center;">
                <form action="{% url 'search_result' %}" method="GET" class="search-form">
                    <input type="text" name="q" class="search-input" placeholder="Search..." required>
                    <button type="submit" class="search-btn">üîç</button>
                </form>
                <a href="{% url 'cart' %}" class="cart-link">
                    üõí <span class="global-badge">{{ cart_count|default:0 }}</span>
                </a>
                <button id="theme-toggle" class="theme-toggle">üåô</button>
            </div>
        </nav>
    </header>

    {% if messages %}
    <div class="toast-container" style="position:fixed; bottom:20px; right:20px; z-index:9999;">
        {% for message in messages %}
        <div
            style="background:#4caf50; color:white; padding:15px; border-radius:5px; margin-top:10px; box-shadow:0 5px 15px rgba(0,0,0,0.2);">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    <script>
        setTimeout(function () {
            document.querySelector('.toast-container').style.display = 'none';
        }, 3000);
    </script>
    {% endif %}

    <main class="profile-container reveal-on-scroll">
        <!-- Sidebar -->
        <aside class="profile-sidebar">
            <div class="user-info">
                <div class="avatar">{{ user.username|make_list|first }}</div>
                <h3>{{ user.first_name }} {{ user.last_name }}</h3>
                <p>@{{ user.username }}</p>
                <p style="margin-top:5px; font-size:12px; opacity:0.7;">Joined: {{ user.date_joined|date:"M Y" }}</p>
            </div>
            <nav class="sidebar-menu">
                <a href="#" class="active" onclick="return false;">üë§ Account Details</a>
                <a href="{% url 'my_orders' %}">üì¶ My Orders</a>
                <a href="{% url 'logout' %}" class="logout">üö™ Logout</a>

                <div
                    style="margin-top: auto; padding: 20px 0 0 0; border-top: 1px solid var(--border-color); margin-top: 20px;">
                    <form method="POST" action="{% url 'delete_account' %}"
                        onsubmit="return confirm('Are you absolutely sure you want to delete your account? This action cannot be undone and you will lose all your order history!');">
                        {% csrf_token %}
                        <button type="submit"
                            style="background: transparent; color: #ff4757; border: 1px solid #ff4757; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: 500; width: 100%; transition: 0.3s;"
                            onmouseover="this.style.background='#ff4757'; this.style.color='white';"
                            onmouseout="this.style.background='transparent'; this.style.color='#ff4757';">
                            ‚ö†Ô∏è Delete Account
                        </button>
                    </form>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <section class="profile-content">

            <!-- Update Profile Form -->
            <div class="settings-card">
                <h3>Update Shipping Address</h3>
                <form class="settings-form" method="POST">
                    {% csrf_token %}

                    <h4 style="margin-bottom:15px; color:var(--text-muted); font-size:14px; text-transform:uppercase;">
                        Personal Info</h4>
                    <div class="form-row">
                        <div class="input-group">
                            <label>First Name</label>
                            <input type="text" name="first_name" value="{{ user.first_name }}">
                        </div>
                        <div class="input-group">
                            <label>Last Name</label>
                            <input type="text" name="last_name" value="{{ user.last_name }}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="input-group">
                            <label>Email Address (ReadOnly)</label>
                            <input type="email" value="{{ user.email }}" readonly
                                style="opacity:0.7; cursor:not-allowed;">
                        </div>
                        <div class="input-group">
                            <label>Phone Number</label>
                            <input type="text" name="phone" value="{{ profile.phone|default:'' }}"
                                placeholder="+1 234 567 8900" oninput="validatePhone(this)">
                        </div>
                    </div>

                    <h4 style="margin:20px 0 15px; color:var(--text-muted); font-size:14px; text-transform:uppercase;">
                        Shipping Details</h4>

                    <div class="input-group">
                        <label>Address Line</label>
                        <input type="text" name="address" value="{{ profile.address|default:'' }}"
                            placeholder="123 Main St">
                    </div>

                    <div class="form-row">
                        <div class="input-group">
                            <label>City</label>
                            <input type="text" name="city" value="{{ profile.city|default:'' }}">
                        </div>
                        <div class="input-group">
                            <label>State / Province</label>
                            <input type="text" name="state" value="{{ profile.state|default:'' }}">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="input-group">
                            <label>Zip Code</label>
                            <input type="text" name="zip_code" value="{{ profile.zip_code|default:'' }}"
                                oninput="validateStrictNumber(this)">
                        </div>
                        <div class="input-group">
                            <label>Country</label>
                            <input type="text" name="country" value="{{ profile.country|default:'' }}">
                        </div>
                    </div>

                    <button type="submit" class="save-btn">Save Changes</button>
                </form>
            </div>


            <!-- Recent Orders Mini-View -->
            <div class="content-header" style="margin-top: 40px;">
                <h2>Recent Orders</h2>
            </div>

            <div class="order-table-container">
                <table class="order-table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Total</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        <tr>
                            <td>#{{ order.id }}</td>
                            <td>{{ order.created_at|date:"M d, Y" }}</td>
                            <td><span class="status {{ order.status }}">{{ order.status }}</span></td>
                            <td>${{ order.total_price }}</td>
                            <td><a href="{% url 'my_orders' %}" class="view-details">View</a></td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" style="text-align:center;">No recent orders.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        </section>
    </main>

    <!-- Standard Footer -->
    <footer class="site-footer reveal-on-scroll">
        <div class="footer-content">
            <div class="footer-brand">
                <h2 class="footer-logo">Stylehub‚Ñ¢</h2>
                <p>We offer a wide range of fashion products to meet all your needs, from casual fits to formal
                    elegance.</p>
                <div class="social-icons">
                    <a href="https://www.instagram.com/">üì∑</a>
                    <a href="https://www.facebook.com/">fb</a>
                    <a href="https://x.com/">‚úï</a>
                </div>
            </div>
            <div class="footer-links">
                <h3>Extra links</h3>
                <ul>
                    <li><a href="{% url 'home' %}">Home</a></li>
                    <li><a href="{% url 'pro_list' %}">Shop</a></li>
                    <li><a href="{% url 'new' %}">New Arrivals</a></li>
                    <li><a href="{% url 'contact' %}">Our Team</a></li>
                    <li><a href="{% url 'about' %}">About Us</a></li>
                </ul>
            </div>
            <div class="footer-contact">
                <h3>Contact</h3>
                <p>LPU, Jalandhar<br>Punjab, 144411</p>
                <p><a href="{% url 'team_emails' %}">Team Emails Directory</a></p>
                <p>(+91) 98765 43210</p>
            </div>
        </div>
    </footer>

    <script>
        function validateStrictNumber(input) {
            if (/[^0-9]/.test(input.value)) {
                alert("This field allows only numbers.");
                input.value = input.value.replace(/[^0-9]/g, '');
            }
        }
        function validatePhone(input) {
            if (/[^0-9\+\-\s]/.test(input.value)) {
                alert("This field allows only numbers, spaces, +, and -.");
                input.value = input.value.replace(/[^0-9\+\-\s]/g, '');
            }
        }
    </script>

    <!-- ADMIN FLOATING BUTTON -->
    {% if user.is_authenticated and user.is_superuser %}
    <a href="{% url 'admin_dashboard' %}" class="floating-admin-btn">
        ‚öôÔ∏è Admin Panel
    </a>
    {% endif %}
</body>

</html>